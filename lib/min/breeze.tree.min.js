(function($,undefined){function TreeNode(tree,node,runtimeData){this.tree=tree;this.node=node;this.runtimeData=runtimeData}TreeNode.prototype={getNode:function(){return this.node},getRuntimeData:function(){return this.runtimeData},getData:function(){return this.runtimeData["d"]},setChecked:function(checked){this.runtimeData["s"]=checked},getChecked:function(){return !!this.runtimeData["s"]},toggle:function(){this.tree.toggle(this.node)},getParent:function(){if(this.node.hasClass("root")){return null}return this.tree.getTreeNode(this.node.parent().parent())},getNext:function(){var node=this.node.next();if(node.length){return this.tree.getTreeNode(node)}return null},getPrev:function(){var node=this.node.prev();if(node.length){return this.tree.getTreeNode(node)}return null},getIndex:function(){return $(">.node",this.node.parent()).index(this.node)}};$.widget("ui.tree",{options:{metadata:{id:"id",pId:"pId",title:"title",iconURL:"iconURL",leaf:"leaf",children:"children"},root:{visibility:true,iconURL:"",title:"Root",id:"---root---"},dataProvider:[],xhr:null,onClick:null,onLoad:null,onExpand:null,onCollapse:null,exclusive:false,plugins:null},_create:function(){this.pluginInstances={};this._topics={};this.nodesbase={};var classes=$.ui.tree.plugins.classes,plugins=this.options.plugins||{};for(var name in classes){if(!plugins[name]){continue}var clazz=classes[name];this.pluginInstances[name]=new clazz(this,plugins[name])}this.transformdata(this.options.dataProvider);this._render();this._funnelEvents();for(var name in this.pluginInstances){var instance=this.pluginInstances[name];instance.startup&&instance.startup()}},templateTreeNode:(function(){var html=["<div class='node'>"];html.push("<div class='header'>");html.push("<div class='status'></div>");html.push("<div class='logic'></div>");html.push("<img class='icon'></img>");html.push("<div class='title'></div>");html.push("</div>");html.push("</div>");return $(html.join(""))[0]})(),transformdata:function(dataProvider){var treeMapping={},rootData=this.options.root,root={c:[],d:{}},_rd=root.d,self=this,md=this.options.metadata;this.root=root;_rd[md.id]=rootData.id;_rd[md.title]=rootData.title;_rd[md.iconURL]=rootData.iconURL;_rd[md.leaf]=false;this.runtimedatasbase={};if(!dataProvider.length){return}if(!(md["pId"] in dataProvider[0])){this.transformtreedata(root,dataProvider);return}var treeMapping={"":root};for(var i=0,data;data=dataProvider[i];i++){var id=data[md.id],pId=data[md.pId]||"";(id in treeMapping)?(treeMapping[id]["d"]=data):(treeMapping[id]={d:data});if(pId in treeMapping){var pData=treeMapping[pId];(pData["c"]||(pData["c"]=[])).push(treeMapping[id])}else{var pData={c:[]};pData["c"].push(treeMapping[id]);treeMapping[pId]=pData}}this.runtimedatasbase=treeMapping;delete treeMapping[""]},transformtreedata:function(runtimeData,children){var md=this.options.metadata;if(children){var dp=runtimeData["c"]||(runtimeData["c"]=[]);for(var i=0,d;d=children[i];i++){var rd={d:d};dp.push(rd);this.runtimedatasbase[d[md["id"]]]=rd;this.transformtreedata(rd,d[md["children"]])}}},_render:function(){var element=this.element,options=this.options;element.addClass("breeze-tree");var rootNode=this.renderNode(this.root,0);rootNode.addClass("root");if(!this.options.root.visibility){rootNode.addClass("noroot")}element.append(rootNode);this.expandNode(rootNode)},renderNode:function(runtimeData,paddingLeft,nocached){var md=this.options.metadata,node=$(this.templateTreeNode.cloneNode(true)),header=$(">.header",node),data=runtimeData["d"],id=data[md.id];header.css("paddingLeft",paddingLeft+"px");node.attr("nodeId",id);$(">.icon",header).attr("src",data[md.iconURL]||breeze.getBlankIcon());$(">.title",header).html(data[md.title]||"&nbsp;");node.addClass(this.isLeafByData(runtimeData)?"leaf":"collapsed");if(true!=nocached){var treeNode=new TreeNode(this,node,runtimeData);this.nodesbase[id]=treeNode}this.publish("renderNode",[treeNode]);return node},isLeafByData:function(runtimeData){var md=this.options.metadata,xhr=this.options.xhr,data=runtimeData["d"],children=runtimeData["c"];return null!=data[md.leaf]?data[md.leaf]:(children!=null?children.length==0:(xhr!=null?false:true))},isLeafByNode:function(node){return node.hasClass("leaf")},makeupsubtree:function(node,callback){if($(">.subtree",node).length){callback&&callback();return}var xhr=this.options.xhr,md=this.options.metadata,treeNode=this.getTreeNode(node),runtimeData=treeNode.getRuntimeData(),children=runtimeData["c"],self=this;if(null==children&&null!=xhr){node.addClass("loading");xhr(runtimeData["d"],function(children){node.removeClass("loading");children=children||[];var dp=[];for(var k=0,child;child=children[k];k++){var rd={d:child};self.runtimedatasbase[child[md["id"]]]=rd;dp.push(rd)}runtimeData["c"]=dp;self.publish("xhr-render",[treeNode]);self._makeupsubtree2(treeNode,callback)});return}this._makeupsubtree2(treeNode,callback)},_makeupsubtree2:function(treeNode,callback){var node=treeNode.getNode(),runtimeData=treeNode.getRuntimeData(),children=runtimeData["c"]||[];if(this.isLeafByData(runtimeData)){node.removeClass("collapsed");node.addClass("leaf");return}var subtree=$("<div class='subtree'></div>"),paddingLeft=this.getLeftPadding(node)+20;for(var i=0,child;child=children[i];i++){subtree.append(this.renderNode(child,paddingLeft))}node.append(subtree);this.publish("makeupsubtree",[treeNode]);callback&&callback()},expandNode:function(node,callback,exclusive){if(this.isLeafByNode(node)){return}if(exclusive){var nodes=$(">.node.expanded",node.parent());for(var i=0,bn;bn=nodes[i];i++){(bn!=node[0])&&this.collapseNode($(bn))}}var subtree=$(">.subtree",node),self=this;if(subtree.length){if(node.hasClass("collapsed")){node.removeClass("collapsed");node.addClass("expanded");setTimeout(function(){if(subtree.width()){subtree.show("fast",function(){callback&&callback();var onExpand=self.options.onExpand;onExpand&&onExpand()})}else{subtree.css("display","block");callback&&callback()}},0)}else{callback&&callback()}return}var self=this;this.makeupsubtree(node,function(){self.expandNode(node,callback,exclusive)})},getLeftPadding:function(node){return parseInt($(">.header",node).css("paddingLeft"),10)},collapseNode:function(node,callback){if(this.isLeafByNode(node)){return}var subtree=$(">.subtree",node),self=this;if(subtree.length){if(node.hasClass("expanded")){node.removeClass("expanded");node.addClass("collapsed");subtree.hide("fast",function(){callback&&callback();var onCollapse=self.options.onCollapse;onCollapse&&onCollapse()})}}},toggle:function(node){this._toggle(node,this.options.exclusive)},_toggle:function(node,exclusive){node.hasClass("expanded")?this.collapseNode(node):this.expandNode(node,null,exclusive)},getTreeNode:function(node){return this.nodesbase[node.attr("nodeId")]},refresh:function(treeNode){var self=this,md=this.options.metadata,node=treeNode.getNode();this.foreach({treeNode:treeNode,each:function(runtimeData){var data=runtimeData["d"],id=data[md["id"]];delete self.runtimedatasbase[id];delete self.nodesbase[id]}});var newNode=this.renderNode(treeNode.getRuntimeData(),this.getLeftPadding(node));node.after(newNode);node.remove();if(this.selectedNode&&(this.selectedNode[0]==node[0])){this.selectedNode=newNode;newNode.addClass("selected")}},expandAll:function(){var expendingNodeList=[];var nodeList=$(".node.collapsed",this.element);for(var i=0,childNode;childNode=nodeList[i];i++){expendingNodeList.push($(childNode))}this._expandAll2(expendingNodeList)},_expandAll2:function(expendingNodeList){var self=this;(function(expendingNodeList){if(expendingNodeList.length==0){return}var func=arguments.callee,node=expendingNodeList.shift();self.expandNode(node,function(){var nodeList=$(">.subtree>.node.collapsed",node);for(var i=nodeList.length-1,childNode;childNode=nodeList[i];i--){expendingNodeList.unshift($(childNode))}self._expandAll2(expendingNodeList)})})(expendingNodeList)},collapseAll:function(){var nodeList=$(".node.expanded",this.element),self=this;(function(index){if(index<0){return}var func=arguments.callee;self.collapseNode($(nodeList[index]),function(){func(index-1)})})(nodeList.length-1)},getRootNode:function(){return this.getTreeNode($(">.root",this.element))},foreach:function(inData){var xhr=this.options.xhr,md=this.options.metadata,runtimeData=inData.treeNode.getRuntimeData(),each=inData.each,complete=inData.complete,whole=inData.whole,self=this;(function(loadingList){if(0==loadingList.length){complete&&complete();return}var func=arguments.callee,data=loadingList.shift();each&&each(data);if(self.isLeafByData(data)){func(loadingList)}else{var children=data["c"];if(null!=children){Array.prototype.push.apply(loadingList,children);func(loadingList)}else{if(whole&&xhr!=null){xhr(data["d"],function(children){children=children||[];var dp=[];for(var k=0,child;child=children[k];k++){var rd={d:child};self.runtimedatasbase[child[md["id"]]]=rd;dp.push(rd)}Array.prototype.push.apply(loadingList,data["c"]=dp);func(loadingList)})}else{func(loadingList)}}}})([runtimeData])},expand:function(xpath,callback){var exclusive=this.options.exclusive,ids=xpath.split("/"),self=this;if(ids.length==1){var treeNode=this.nodesbase[xpath];if(treeNode){var node=treeNode.getNode().parent();while(this.element[0]!=node[0]){if(node.hasClass("node")){ids.unshift(node.attr("nodeId"))}node=node.parent()}ids.shift()}}ids.unshift(this.options.root.id);(function(subtree){var func=arguments.callee,node=$(">.node[nodeId='"+ids.shift()+"']",subtree);if(!node.hasClass("leaf")){self.expandNode(node,function(){ids.length?func($(">.subtree",node)):(callback&&callback(node))},exclusive)}else{callback&&callback(node)}})(this.element)},select:function(xpath,callback){var ids=xpath.split("/"),self=this,exclusive=this.options.exclusive;if(ids.length==1){var treeNode=this.nodesbase[xpath];if(treeNode){var node=treeNode.getNode().parent();while(this.element[0]!=node[0]){if(node.hasClass("node")){ids.unshift(node.attr("nodeId"))}node=node.parent()}ids.shift()}}ids.unshift(this.options.root.id);(function(subtree){var func=arguments.callee,node=$(">.node[nodeId='"+ids.shift()+"']",subtree);if(ids.length==0){self.switchSelectedNode(node);callback&&callback();return}if(!node.hasClass("leaf")){self.expandNode(node,function(){func($(">.subtree",node))},exclusive)}})(this.element)},getSelected:function(){if(this.selectedNode){return this.nodesbase[this.selectedNode.attr("nodeId")]}},switchSelectedNode:function(node){if(this.selectedNode){this.selectedNode.removeClass("selected")}node.addClass("selected");this.selectedNode=node},clearSelectedNode:function(){if(this.selectedNode){this.selectedNode.removeClass("selected");this.selectedNode=null}},_funnelEvents:function(){var self=this;this.element.click(function(e){var element=$(e.target);if(element.hasClass("status")||element.hasClass("icon")){self.toggle(breeze.parent(element,"node"))}else{if(element.hasClass("title")){var node=breeze.parent(element,"node"),onClick=self.options.onClick;self.switchSelectedNode(node);onClick&&onClick(self.getTreeNode(node))}}})},getPlugin:function(name){return this.pluginInstances[name]},publish:function(topic,args){$.each(this._topics[topic]||[],function(index,method){method.apply(null,args||[])})},subscribe:function(topic,context,method){topic=topic.split(".");var id=topic[1]||"";topic=topic[0];var listener=this._topics[topic]||(this._topics[topic]=[]);function fn(){(jQuery.isFunction(method)&&method||context[method]).apply(context,arguments)}fn.id=id;listener.push(fn)},unsubscribe:function(topic){topic=topic.split(".");var id=topic[1]||"";topic=topic[0];if(null==id){delete this._topics[topic];return}var listener=this._topics[topic]||[];for(var i=listener.length-1,fn;fn=listener[i];i--){if(fn.id==id){listener.splice(i,1)}}}});$.ui.tree.plugins=new function(){this.classes={};this.register=function(name,clazz){this.classes[name]=clazz}}()})(jQuery);